//
//  Level.swift
//  Malware Mind
//
//  Created by Pedro Henrique on 06/04/21.
//

import UIKit
import GameplayKit

class Level: NSObject {

    var width: Int {
        Int(mazeWidth)
    }
    var height: Int {
        Int(mazeHeight)
    }
    
    var startPosition: GKGridGraphNode?
    var enemyStartPositions: [GKGridGraphNode] = []
    var collectablePositions: [GKGridGraphNode] = []
    
    var pathfindingGraph: GKGridGraph<GKGridGraphNode>?

    private let mazeWidth: Int32 = 7
    private let mazeHeight: Int32 = 11
    
    private var maze = [
        0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,
        0,0,2,3,0,0,0,
        0,0,0,1,1,1,1,
        0,0,0,4,0,0,0,
        0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,
        0,0,0,0,0,0,0
    ]
    
    override init() {
        super.init()

        let graphStartingVector: SIMD2<Int32> = .zero
        let graph: GKGridGraph = GKGridGraph(
            fromGridStartingAt: graphStartingVector,
            width: Int32(mazeWidth),
            height: Int32(mazeHeight),
            diagonalsAllowed: false
        )

        var walls: [GKGridGraphNode] = []
        var spawnPoints: [GKGridGraphNode] = []
        var collectables: [GKGridGraphNode] = []

        for horizontalCoordinate in 0..<mazeWidth {
            for verticalCoordinate in 0..<mazeHeight {

                let tile = self.tileValue(atRow: horizontalCoordinate, column: verticalCoordinate)
                let tileGridPosition = SIMD2<Int32>(horizontalCoordinate, verticalCoordinate)
                if tile == TileType.wall {
                    if let node = graph.node(atGridPosition: tileGridPosition) {
                        walls.append(node)
                    }
                } else if tile == TileType.enemy {
                    if let node = graph.node(atGridPosition: tileGridPosition) {
                        spawnPoints.append(node)
                    }
                } else if tile == TileType.collect {
                    if let node = graph.node(atGridPosition: tileGridPosition) {
                        collectables.append(node)
                    }
                } else if tile == TileType.player {
                    startPosition = graph.node(atGridPosition: tileGridPosition)
                }
            }

        }

        graph.remove(walls as [GKGraphNode])

        enemyStartPositions = spawnPoints
        collectablePositions = collectables

        pathfindingGraph = graph
    }
    
    func tileValue(atRow row: Int32, column col: Int32) -> TileType? {
        let tileTypeRawValue: Int = Int(maze[Int(row + col * mazeWidth)])
        return TileType(rawValue: tileTypeRawValue)
    }
    
}
