//
//  EnemyState.swift
//  Malware Mind
//
//  Created by Pedro Henrique on 18/03/21.
//

import Foundation
import GameplayKit

class VirusBaseState: GKState {
    
    weak var game: GameScene!
    var entity: BaseEntity

    init(game: GameScene, entity: BaseEntity) {
        self.game = game
        self.entity = entity
        super.init()
    }

// MARK: - Path Finding & Following
    func path(to node: GKGridGraphNode) -> [GKGridGraphNode]? {
        guard let game = game, let gridPosition = entity.gridPosition else {
            return nil
        }

        let graph = game.level.pathfindingGraph
        let enemyNode = graph?.node(atGridPosition: gridPosition)

        if let enemyNode = enemyNode {
            return graph?.findPath(from: enemyNode, to: node) as? [GKGridGraphNode]
        }

        return nil
    }

    func start(followingPath path: [GKGridGraphNode]?) {
        guard let path = path else { return }
        if (path.count > 1) {
            let firstMove = path[1] // path[0] is the enemy's current position.
            let component = entity.component(ofType: AnimatedSpriteComponent.self)
            component?.nextGridPosition = firstMove.gridPosition
        }
    }
    
}
